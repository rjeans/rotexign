# Agent Design Notes <a id="agent-design-notes"></a>

## INPUT <a id="input"></a>

The output of the inductive sensor looks like this:

### Diagram Description
- **X-axis:** Time  
- **Y-axis:** Sensor voltage output  
- Shows a series of pulses generated by the inductive sensor as the flywheel lobes pass.  
- The leading edge of each pulse is **negative-going**.  
- Each pulse is followed by noise spikes caused by spark discharge.  
- Noise amplitude is irregular, creating potential false triggers.

---

My input circuit looks like this (full image at the end):

### Diagram Description
- **Components:**  
  - Inductive sensor input → optocoupler  
  - Pull-up resistor tied to Arduino D2 input pin  
  - Output of optocoupler pulls D2 low when triggered  
- **Logic:**  
  - Arduino reads a **negative-edged pulse** at D2.  
  - Circuit inversion ensures the **negative pulse occurs first**, giving maximum time before ignition point.  

---

The sensor output vs the Arduino input looks like this:  
*(note the noise as the spark happens which is a problem)*

### Diagram Description
- Overlay plot of two signals:  
  - **Sensor output (analog):** sine-like pulse with noise  
  - **Arduino D2 input (digital):** sharp square pulse, low when optocoupler is active  
- At spark event → large noise burst visible on sensor trace  
- Digital trace sometimes shows **false edges** due to noise spikes.

---

## OUTPUT <a id="output"></a>

The ignition coil is a **1GN-1A smart coil**.  

### Diagram Description
- Input: **5V TTL pulse** from Arduino  
- Power: separate **12V supply** direct from battery  
- Logic:  
  - Rising edge of 5V → coil begins charging (dwell start)  
  - Falling edge → coil fires spark plug (dwell end)  
- Dwell duration = width of 5V pulse.  

**Operating Recommendations:**
- Maximum continuous duty cycle: **40%**
- Maximum dwell time @14V: **9 ms**
- For a 12V battery, charging dwell should be about **3 ms**

⚠️ A basic error in my design:  
When the Arduino started up there was no output from D3 to ground the output to the coil.  
This meant the maximum dwell time was exceeded and I burnt out the first coil.  

**Fix:** I soldered in a small relay to ground the output until the Arduino powered up.

```cpp
digitalWrite(3, HIGH);   // starts with the optocouplers fired and the outputs low
digitalWrite(4, HIGH);   // takes the short circuit off the opto
```

**Important:**  
The software can never leave the output HIGH as it will burn out the coil.

---

## ENGINE - ROTAX 787 <a id="engine-rotax-787"></a>

Flywheel lobes that produce the sensor output look like this:

### Diagram Description
- Circular flywheel with **two lobes** per revolution.  
- Each lobe induces a pulse in the inductive sensor.  
- Because there is only one coil:  
  - Both cylinders receive spark simultaneously → **wasted spark system**.  
- Ideal setup would use two coils, but no reference signal exists to identify cylinder.  

**Operating conditions:**
- Engine revs to **7000 rpm**  
- At 7000 rpm → cannot maintain duty cycle of 40% and dwell of 3ms  
  - Engine will still run on lower dwell time
- Spark should **cut above 7000 rpm**
- **TDC (Top Dead Centre)** of each piston = **47° past trigger point**
- Software should be configurable for setup with a timing light
- At 7000 rpm → not enough time to use the lobe nearest firing point  
  - Partial success using the previous lobe, but not perfected

---

## NOISE <a id="noise"></a>

Noise during spark is causing multiple outputs (red line).

### Diagram Description
- Graph with:  
  - **Blue trace:** intended clean input pulse  
  - **Red trace:** noisy Arduino output, multiple transitions instead of single edge  
- Shows that without filtering, **spurious triggers** cause multiple sparks.  

By checking pulse duration, improved filtering was achieved:

### Diagram Description
- Graph comparing before/after filtering:  
  - **Before:** multiple pulses during noise region  
  - **After:** single clean pulse maintained by ignoring short-duration glitches.  

---

## TIMING CURVE <a id="timing-curve"></a>

### Diagram Description
- Table or curve with RPM on X-axis, ignition advance (degrees BTDC) on Y-axis.  
- **Actual curve (OEM?):** rises steeply from 0° to 20° by 3000 RPM, then slowly retards to ~17° at 7000 RPM.  
- **Safe curve:** same shape, but maximum advance limited to 15°.  
- Purpose: to allow configurability for tuning and safe operation at high revs.

| RPM   | 0  | 1000 | 2000 | 3000 | 4000 | 5000 | 6000 | 7000 |
|-------|----|------|------|------|------|------|------|------|
| Actual? | 0  | 6    | 12   | 20   | 20   | 19   | 18   | 17   |
| Safe?   | 0  | 6    | 12   | 15   | 15   | 14   | 13   | 12   |

---
